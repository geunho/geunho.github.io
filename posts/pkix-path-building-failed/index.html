<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    

    
      <link href='https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400' rel='stylesheet' type='text/css'>
    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <title>
      
      
         Java - PKIX path building failed 
      
    </title>
    <link rel="canonical" href="https://blog.geunho.dev/posts/pkix-path-building-failed/">

    <style>
  * {
    border:0;
    font:inherit;
    font-size:100%;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
  }

  body {
    font-family:'Open Sans', 'Myriad Pro', Myriad, sans-serif;
    font-size:17px;
    line-height:160%;
    color:#1d1313;
    max-width:700px;
    margin:auto;
  }

  .footnotes {
    margin: 30px 0 40px 0;
  }
  sup.footnote-ref {
    font-size: 0.85em;
    vertical-align: top;
    position: relative;
    top: -0.5em;
  }

  footer {
    font-size: x-small;
    letter-spacing: 0.5px;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 75%;
    display: block;
  }

  .left-justify {
    float: left;
  }

  .right-justify {
    float:right;
  }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    font-size: 12px;
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    max-width: auto;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  .heading,.serif,h1,h2,h3 {
    font-family:"Old Standard TT",serif;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    font-size:35px;
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }

  h1 {
    font-size:35px;
  }

  h2 {
    font-size:28px;
  }

  h3 {
    font-size:22px;
    margin-top:18px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  #sub-header, time {
    color:#403c3b;
    font-size:13px;
  }

  #sub-header {
    margin: 0 4px;
  }

  #nav h1 a {
    font-size:35px;
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 5px;
  }

  ul li {
    list-style-type: none;
  }

  ul li:before {
    content:"\2022 \0020";
  }

  ul li ul li:before {
    content:"\2043 \0020";
  }

  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    font-size:15px;
    padding:60px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content h2 {
    font-size:25px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content time {
    margin-left:3px;
  }

  #content h1 {
    font-size:30px;
  }

  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

  .posts_listing li a:hover,#nav a:hover {
    text-decoration: underline;
  }

  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  #nav ul {
    display: table;
    margin: 8px auto 0 auto;
  }

  #nav li {
    list-style-type:none;
    display:table-cell;
    font-size:15px;
    padding: 0 20px;
  }

  #links {
    margin: 50px 0 0 0;
  }

  #links :nth-child(2) {
    float:right;
  }

  img.avatar {
    border-radius: 50%;
    width: 300px;
  }

   
  .social_id {
    color:#9b9b9b; 
    font-size:10px;
    text-align:center;
  }
  .social-icons {
    display: flex;
    justify-content: center;
  }
  .social-icons__icon {
    width: 1.5rem;
    height: 1.5rem;
    background-size: contain;
    background-repeat: no-repeat;
  }
  
  .social-icons__icon--linkedin {
    background-image: url(/icons/linkedin.svg);
    margin-right: 2rem;    
  }
  .social-icons__icon--github {
    background-image: url(/icons/github.svg);
    margin-right: 2rem; 
  }
  .social-icons__icon--gmail {
    background-image: url(/icons/gmail.svg);
  }

  .rss-icon {
    display: flex;
    width: 1.2rem;
    height: 1.2rem;
    background-size: contain;
    background-repeat: no-repeat;
    background-image: url(/icons/rss.svg);
  }

  #not-found {
    display: flex;
  }
  .not-found__icon--docker {
    width: 1.4rem;
    height: 1.4rem;
    margin-right: 0.5em;
    background-size: contain;
    background-repeat: no-repeat;
    background-image: url(/icons/docker.svg);
  }

  nav#TableOfContents {
    margin: 20px 0 50px 0;
  }

  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    img {
      max-width: 80%;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 15px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    img {
      max-width: 100%;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 10px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }

    img.avatar {
      border-radius: 50%;
      width: 170px;
    }
  }
</style>


    
  </head>

  <body>
    <section id=nav>
      <h1><a href="/">Blog · 김근호(Kim, Geunho)</a></h1>
      <ul>
        
          <li><a href="/about">About</a></li>
        
          <li><a href="/posts">Posts</a></li>
        
          <li><a href="/thoughts">Thoughts</a></li>
        
          <li><a href="/til">TIL</a></li>
        
        <a class="rss-icon" href="/index.xml"></a>
      </ul>
    </section>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146312497-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<section id="content">
  <h1> Java - PKIX path building failed </h1>

  
    <div id="sub-header">
      7 November 2019 · 2 minutes read
    </div>
  

  <nav id="TableOfContents"></nav>

  <div class="entry-content">
    <h1 id="오류-발생-원인">오류 발생 원인</h1>
<p>SSL 연결이 필요한 웹 리소스를 웹 브라우저에서는 신뢰하는 인증서로 확인됨에도 자바 클라이언트에서 아래와 같은 오류가 발생할 때가 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested
</code></pre></div><p>오류 메시지 내용대로, 요청에 대해 올바른 인증 경로를 찾지 못했다는 것인데 왜 브라우저에서는 확인된 인증서가 애플리케이션에서는 오류가 발생하는걸까?</p>
<p>그 답은 SSL 연결의 HANDSHAKE 과정을 살펴보면 알 수 있다.</p>
<ol>
<li>클라이언트가 CA<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>로 부터 발급받은 인증서로 서비스허는 서버로 연결을 맺는다.</li>
<li>서버가 전송한 인증서가 CA로 부터 발급받은 것인지 확인한다. 클라이언트는 CA와 공개키 목록을 가지고 있다.</li>
<li>신뢰할 수 있는 CA로 부터 발급된 인증서로 확인이 되면 CA의 공개키로 인증서를 복호화한다.</li>
<li>세션 키 값을 생성해서 인증서에 저장된 서버의 공개키로 암호화해서 서버로 전송한다.</li>
<li>세션 키로 암호화된 요청을 전송한다.</li>
</ol>
<p>오류가 발생하는 지점은 2번 단계로 클라이언트가 신뢰하는 CA 목록에 인증서가 발급된 CA가 없는 경우 발생하는 것이다.</p>
<p>다시 말해서 웹 브라우저에서 요청시 신뢰할 수 있는 인증서로 표기되는 서비스라면, 오류가 발생하는 자바 클라이언트가 가지고 있는 CA 목록이 오래되었다는 뜻이다.</p>
<p>따라서 위의 오류는 주로 오래된 버전의 자바 클라이언트에서 발생한다. HANDSHAKE 단계에서 발생한 오류이기 때문에 서버로는 어떠한 요청 유입도 되지 않아서 오류 로그도 남지 않는다.
오류는 연결을 시도한 클라이언트에만 남기 때문에 이러한 오류를 서버 측에서 먼저 인지하기는 어렵다.</p>
<h1 id="해결-방법">해결 방법</h1>
<p>자바 애플리케이션은 keystore 파일에 CA 목록을 유지한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$JAVA_HOME/lib/security/cacerts
# 혹은
$JAVA_HOME/jre/lib/security/cacerts
</code></pre></div><p>여기서 <code>$JAVA_HOME/bin/keytool</code> 도구로 CA 목록을 출력/추가/삭제할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">keytool -list -v -keystore $JAVA_HOME/lib/security/cacerts | grep &#39;Owner:&#39; | grep DIgiCert
Enter keystore password: # 패스워드는 default 값으로 &#39;changeit&#39;

Owner: CN=DigiCert Assured ID Root CA, OU=www.digicert.com, O=DigiCert Inc, C=US
Owner: CN=DigiCert High Assurance EV Root CA, OU=www.digicert.com, O=DigiCert Inc, C=US
Owner: CN=DigiCert Global Root CA, OU=www.digicert.com, O=DigiCert Inc, C=US
</code></pre></div><p>이제 오류가 발생하는 도메인의 인증서 정보를 내려받아보자.
<code>openssl</code> 도구로 인증서 체인 정보를 출력할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">openssl s_client -connect blog.geunho.dev:443 -showcerts
</code></pre></div><p>출력 중 PEM 형식에 해당하는 <code>BEGIN CERTIFICATE</code> ~ <code>END CERTIFICATE</code> 내용을 복사해서 <code>my.crt</code> 파일에 내용을 기록한다.
여러 목록이 나타난다면 각각 다른 <code>.crt</code> 파일에 기록해서 저장한다.</p>
<p>이제 다시 <code>keytool</code> 도구로 <code>.crt</code> 파일을 통해 CA를 등록할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">keytool -import -alias mycert -keystore $JAVA_HOME/lib/security/cacerts -file my.crt
Enter keystore password: # 패스워드는 default 값으로 &#39;changeit&#39;
</code></pre></div><p>애플리케이션을 재시작하면 이제 요청/응답을 잘 받는 것을 확인할 수 있다.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://en.wikipedia.org/wiki/Certificate_authority">CA (Certificate Authority)</a>, 인증서를 발급하는 신뢰할 수 있는 인증 기관 <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

  </div>

  
    <div id="sub-header">
      Updated 7 November 2019
    </div>
  

  <div id="links">
    
      <a class="basic-alignment left" href="https://blog.geunho.dev/posts/vue-instance-and-components/">&laquo; Vuejs 정리 1 - 인스턴스와 컴포넌트</a>
    
    
      <a class="basic-alignment left" href="https://blog.geunho.dev/posts/docker-old-os-editor/">Docker - 오래된 버전의 OS 베이스 이미지에 텍스트 편집기 설치하기 &raquo;</a>
    
  </div>
</section>
<section id="comment">
  <script src="https://utteranc.es/client.js"
    repo="geunho/blog"
    issue-term="title"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>  
</section>

<footer>
  <div>
    <p>
    &copy; 2013-2020 Copyright Geunho Kim. All rights reserved.
    </p>
  </div>
</footer>

